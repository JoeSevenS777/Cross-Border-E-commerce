Option Explicit

' ==========================================================
' Export place-order rows from sheets:
'   【萌睫】 / 【采菁】 / 【Flortte】 / 【夹子】
'
' into:
'   - Joe77采购单_<店铺>yyyymmdd.xlsx
'   - Bigseller采购导入_<店铺>yyyymmdd.xlsx
'
' 夹子规则（按 Flortte 同模式）：
'   - Joe77采购单：仅两列【SKU】【数量】；并去掉前缀（不区分大小写）
'       * MJ-夹子-
'       * MJ-JiaZi-
'   - Bigseller采购导入：通用导出（SKU / 数量）
' ==========================================================

Private gJoePath As String
Private gImpPath As String

Public Sub Joe采购单_Bigseller采购导入()
    Dim ws As Worksheet
    Dim scrn As Boolean, calc As XlCalculation, evt As Boolean
    Dim resp As VbMsgBoxResult

    gJoePath = "": gImpPath = ""

    If ActiveWorkbook Is Nothing Then Exit Sub
    If Not ActiveWorkbook Is ThisWorkbook Then
        MsgBox "请在包含宏的工作簿中运行此宏。", vbExclamation
        Exit Sub
    End If

    If Len(ThisWorkbook.Path) = 0 Then
        MsgBox "当前工作簿尚未保存，请先保存后再运行此宏。", vbExclamation
        Exit Sub
    End If

    Set ws = ActiveSheet

    If ws.Name <> "萌睫" And ws.Name <> "采菁" And ws.Name <> "Flortte" And ws.Name <> "夹子" Then
        MsgBox "此宏只适用于工作表【萌睫】【采菁】【Flortte】【夹子】。", vbInformation
        Exit Sub
    End If

    scrn = Application.ScreenUpdating
    calc = Application.Calculation
    evt = Application.EnableEvents
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    Application.EnableEvents = False

    On Error GoTo CleanExit

    Select Case ws.Name
        Case "萌睫": Handle_MengJie ws
        Case "采菁": Handle_CaiJing ws
        Case "Flortte": Handle_Flortte ws
        Case "夹子": Handle_JiaZi ws
    End Select

CleanExit:
    Application.ScreenUpdating = scrn
    Application.Calculation = calc
    Application.EnableEvents = evt

    If Err.Number <> 0 Then
        MsgBox "出错：" & Err.Number & " - " & Err.Description, vbCritical
    Else
        resp = MsgBox("文件已全部生成。是否现在打开 Joe77采购单 和 Bigseller采购导入 文件？", vbYesNo + vbQuestion, "完成")
        If resp = vbYes Then
            On Error Resume Next
            If Len(gJoePath) > 0 And Dir(gJoePath) <> "" Then Workbooks.Open gJoePath
            If Len(gImpPath) > 0 And Dir(gImpPath) <> "" Then Workbooks.Open gImpPath
            On Error GoTo 0
        End If
    End If
End Sub

Private Function CountPlaceOrder(ByVal ws As Worksheet) As Long
    Dim actCol As Long, lastRow As Long, r As Long
    Dim v As String

    actCol = FindHeaderCol(ws, "action")
    If actCol = 0 Then Exit Function

    lastRow = ws.Cells(ws.Rows.Count, actCol).End(xlUp).Row
    For r = 2 To lastRow
        v = LCase$(Trim$(CStr(ws.Cells(r, actCol).Value)))
        If v = "place order" Then CountPlaceOrder = CountPlaceOrder + 1
    Next r
End Function

Private Sub EnsureTodayFile(ByVal folderPath As String, ByVal prefix As String, ByVal todayName As String)
    Dim todayFull As String
    Dim f As String, oldFull As String

    If Right$(folderPath, 1) <> "\" And Right$(folderPath, 1) <> "/" Then
        folderPath = folderPath & Application.PathSeparator
    End If

    todayFull = folderPath & todayName
    If Dir(todayFull) <> "" Then Exit Sub

    f = Dir(folderPath & prefix & "*.xlsx")
    If f <> "" Then
        oldFull = folderPath & f
        On Error Resume Next
        Name oldFull As todayFull
        On Error GoTo 0
    End If
End Sub

' ---------------- 萌睫 ----------------
Private Sub Handle_MengJie(ByVal ws As Worksheet)
    Dim basePath As String, datePart As String
    Dim joePrefix As String, impPrefix As String
    Dim joeNameToday As String, impNameToday As String
    Dim joePath As String, impPath As String

    If CountPlaceOrder(ws) = 0 Then
        MsgBox "【萌睫】中没有 ""place order"" 行，未生成任何文件。", vbInformation
        Exit Sub
    End If

    basePath = ThisWorkbook.Path
    datePart = Format(Date, "yyyymmdd")

    joePrefix = "Joe77采购单_萌睫"
    impPrefix = "Bigseller采购导入_萌睫"

    joeNameToday = joePrefix & datePart & ".xlsx"
    impNameToday = impPrefix & datePart & ".xlsx"

    EnsureTodayFile basePath, joePrefix, joeNameToday
    EnsureTodayFile basePath, impPrefix, impNameToday

    joePath = basePath & Application.PathSeparator & joeNameToday
    impPath = basePath & Application.PathSeparator & impNameToday

    gJoePath = joePath
    gImpPath = impPath

    Export_Mengjie_Joe77 ws, joePath
    Export_ImportFile ws, impPath
End Sub

Private Sub Export_Mengjie_Joe77(ByVal wsSrc As Worksheet, ByVal filePath As String)
    Dim wb As Workbook, ws As Worksheet
    Dim linkCol As Long, attrCol As Long, qtyCol As Long, actCol As Long
    Dim lastRow As Long, r As Long, dstRow As Long
    Dim actVal As String
    Dim oldAlerts As Boolean

    actCol = FindHeaderCol(wsSrc, "action")
    linkCol = FindHeaderCol(wsSrc, "商品链接")
    attrCol = FindHeaderCol(wsSrc, "属性SKU")
    qtyCol = FindHeaderCol(wsSrc, "数量")

    If actCol = 0 Or linkCol = 0 Or attrCol = 0 Or qtyCol = 0 Then
        MsgBox "【萌睫】中未找到必要表头（action / 商品链接 / 属性SKU / 数量）。", vbCritical
        Exit Sub
    End If

    If Dir(filePath) <> "" Then
        Set wb = Workbooks.Open(filePath)
        Set ws = wb.Worksheets(1)
        lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
        If lastRow < 2 Then lastRow = 2
        ws.Range(ws.Cells(2, 1), ws.Cells(lastRow, 3)).ClearContents
    Else
        Set wb = Workbooks.Add(xlWBATWorksheet)
        Set ws = wb.Worksheets(1)
    End If

    ws.Cells(1, 1).Value = "商品链接"
    ws.Cells(1, 2).Value = "属性SKU"
    ws.Cells(1, 3).Value = "数量"

    lastRow = wsSrc.Cells(wsSrc.Rows.Count, actCol).End(xlUp).Row
    dstRow = 2

    For r = 2 To lastRow
        actVal = LCase$(Trim$(CStr(wsSrc.Cells(r, actCol).Value)))
        If actVal = "place order" Then
            ws.Cells(dstRow, 1).Value = wsSrc.Cells(r, linkCol).Value
            ws.Cells(dstRow, 2).Value = wsSrc.Cells(r, attrCol).Value
            ws.Cells(dstRow, 3).Value = wsSrc.Cells(r, qtyCol).Value
            dstRow = dstRow + 1
        End If
    Next r

    ws.Columns.AutoFit

    oldAlerts = Application.DisplayAlerts
    Application.DisplayAlerts = False
    wb.SaveAs fileName:=filePath, FileFormat:=xlOpenXMLWorkbook
    wb.Close SaveChanges:=False
    Application.DisplayAlerts = oldAlerts
End Sub

' ---------------- Flortte ----------------
Private Sub Handle_Flortte(ByVal ws As Worksheet)
    Dim basePath As String, datePart As String
    Dim joePrefix As String, impPrefix As String
    Dim joeNameToday As String, impNameToday As String
    Dim joePath As String, impPath As String

    If CountPlaceOrder(ws) = 0 Then
        MsgBox "【Flortte】中没有 ""place order"" 行，未生成任何文件。", vbInformation
        Exit Sub
    End If

    basePath = ThisWorkbook.Path
    datePart = Format(Date, "yyyymmdd")

    joePrefix = "Joe77采购单_Flortte"
    impPrefix = "Bigseller采购导入_Flortte"

    joeNameToday = joePrefix & datePart & ".xlsx"
    impNameToday = impPrefix & datePart & ".xlsx"

    EnsureTodayFile basePath, joePrefix, joeNameToday
    EnsureTodayFile basePath, impPrefix, impNameToday

    joePath = basePath & Application.PathSeparator & joeNameToday
    impPath = basePath & Application.PathSeparator & impNameToday

    gJoePath = joePath
    gImpPath = impPath

    Export_2Col_Joe77_SkuQty ws, joePath, "MJ-Flortte-"
    Export_ImportFile ws, impPath
End Sub

' ---------------- 夹子（按 Flortte 同模式） ----------------
Private Sub Handle_JiaZi(ByVal ws As Worksheet)
    Dim basePath As String, datePart As String
    Dim joePrefix As String, impPrefix As String
    Dim joeNameToday As String, impNameToday As String
    Dim joePath As String, impPath As String

    If CountPlaceOrder(ws) = 0 Then
        MsgBox "【夹子】中没有 ""place order"" 行，未生成任何文件。", vbInformation
        Exit Sub
    End If

    basePath = ThisWorkbook.Path
    datePart = Format(Date, "yyyymmdd")

    joePrefix = "Joe77采购单_夹子"
    impPrefix = "Bigseller采购导入_夹子"

    joeNameToday = joePrefix & datePart & ".xlsx"
    impNameToday = impPrefix & datePart & ".xlsx"

    EnsureTodayFile basePath, joePrefix, joeNameToday
    EnsureTodayFile basePath, impPrefix, impNameToday

    joePath = basePath & Application.PathSeparator & joeNameToday
    impPath = basePath & Application.PathSeparator & impNameToday

    gJoePath = joePath
    gImpPath = impPath

    ' 夹子可能有两种前缀，均尝试去掉
    Export_2Col_Joe77_SkuQty ws, joePath, "MJ-夹子-", "MJ-JiaZi-"
    Export_ImportFile ws, impPath
End Sub

' ============== 通用：Joe77采购单（两列 SKU/数量，可选剥离多个前缀） ==============
Private Sub Export_2Col_Joe77_SkuQty(ByVal wsSrc As Worksheet, ByVal filePath As String, ParamArray prefixes())
    Dim wb As Workbook, ws As Worksheet
    Dim actCol As Long, skuCol As Long, qtyCol As Long
    Dim lastRow As Long, r As Long, dstRow As Long
    Dim actVal As String
    Dim oldAlerts As Boolean
    Dim skuVal As String
    Dim i As Long

    actCol = FindHeaderCol(wsSrc, "action")
    skuCol = FindHeaderCol(wsSrc, "SKU")
    qtyCol = FindHeaderCol(wsSrc, "数量")

    If actCol = 0 Or skuCol = 0 Or qtyCol = 0 Then
        MsgBox "【" & wsSrc.Name & "】中未找到必要表头（action / SKU / 数量）。", vbCritical
        Exit Sub
    End If

    If Dir(filePath) <> "" Then
        Set wb = Workbooks.Open(filePath)
        Set ws = wb.Worksheets(1)
        lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
        If lastRow < 2 Then lastRow = 2
        ws.Range(ws.Cells(2, 1), ws.Cells(lastRow, 2)).ClearContents
    Else
        Set wb = Workbooks.Add(xlWBATWorksheet)
        Set ws = wb.Worksheets(1)
    End If

    ws.Cells(1, 1).Value = "SKU"
    ws.Cells(1, 2).Value = "数量"

    lastRow = wsSrc.Cells(wsSrc.Rows.Count, actCol).End(xlUp).Row
    dstRow = 2

    For r = 2 To lastRow
        actVal = LCase$(Trim$(CStr(wsSrc.Cells(r, actCol).Value)))
        If actVal = "place order" Then
            skuVal = CStr(wsSrc.Cells(r, skuCol).Value)
            If Not IsMissing(prefixes) Then
                For i = LBound(prefixes) To UBound(prefixes)
                    skuVal = StripPrefixCI(skuVal, CStr(prefixes(i)))
                Next i
            End If
            ws.Cells(dstRow, 1).Value = skuVal
            ws.Cells(dstRow, 2).Value = wsSrc.Cells(r, qtyCol).Value
            dstRow = dstRow + 1
        End If
    Next r

    ws.Columns.AutoFit

    oldAlerts = Application.DisplayAlerts
    Application.DisplayAlerts = False
    wb.SaveAs fileName:=filePath, FileFormat:=xlOpenXMLWorkbook
    wb.Close SaveChanges:=False
    Application.DisplayAlerts = oldAlerts
End Sub

' ============== 通用：Bigseller采购导入（SKU/数量） ==============
Private Sub Export_ImportFile(ByVal wsSrc As Worksheet, ByVal filePath As String)
    Dim wb As Workbook, ws As Worksheet
    Dim skuCol As Long, qtyCol As Long, actCol As Long
    Dim lastRow As Long, dstRow As Long, r As Long
    Dim actVal As String
    Dim headers As Variant, i As Long
    Dim oldAlerts As Boolean

    actCol = FindHeaderCol(wsSrc, "action")
    skuCol = FindHeaderCol(wsSrc, "SKU")
    qtyCol = FindHeaderCol(wsSrc, "数量")

    If actCol = 0 Or skuCol = 0 Or qtyCol = 0 Then
        MsgBox wsSrc.Name & " 中未找到必要表头（action / SKU / 数量）。", vbCritical
        Exit Sub
    End If

    If Dir(filePath) <> "" Then
        Set wb = Workbooks.Open(filePath)
        Set ws = wb.Worksheets(1)
        lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
        If lastRow < 2 Then lastRow = 2
        ws.Range(ws.Cells(2, 1), ws.Cells(lastRow, 18)).ClearContents
    Else
        headers = Array( _
            "*Provisional No.(Required)", _
            "*SKU Name(Required)", _
            "*Purchase Qty(Required)", _
            "Unit Price", _
            "Supplier", _
            "Ship Fee", _
            "Ship Fee Allocation Method (Price/Quantity/Volume/Weight)", _
            "Other Fee", _
            "Other Fee Allocation Method (Price/Quantity/Volume/Weight)", _
            "Tax Fee", _
            "Tax Fee Allocation Method (Price/Quantity/Volume/Weight)", _
            "First-mile Ship Fee", _
            "First-mile Ship Fee Allocation Method (Price/Quantity/Volume/Weight)", _
            "Currency" & vbLf & "(Select from the options)", _
            "Exchange Rate", _
            "Tracking No.", _
            "Estimated Arrival Date", _
            "Note" _
        )


        Set wb = Workbooks.Add(xlWBATWorksheet)
        Set ws = wb.Worksheets(1)
        For i = LBound(headers) To UBound(headers)
            ws.Cells(1, i + 1).Value = headers(i)
        Next i
    End If

    dstRow = 2
    lastRow = wsSrc.Cells(wsSrc.Rows.Count, actCol).End(xlUp).Row
    For r = 2 To lastRow
        actVal = LCase$(Trim$(CStr(wsSrc.Cells(r, actCol).Value)))
        If actVal = "place order" Then
            ws.Cells(dstRow, 1).Value = 1
            ws.Cells(dstRow, 2).Value = wsSrc.Cells(r, skuCol).Value
            ws.Cells(dstRow, 3).Value = wsSrc.Cells(r, qtyCol).Value
            dstRow = dstRow + 1
        End If
    Next r

    ws.Columns.AutoFit

    oldAlerts = Application.DisplayAlerts
    Application.DisplayAlerts = False
    wb.SaveAs fileName:=filePath, FileFormat:=xlOpenXMLWorkbook
    wb.Close SaveChanges:=False
    Application.DisplayAlerts = oldAlerts
End Sub

' ---------------- 采菁（原逻辑保留） ----------------
Private Sub Handle_CaiJing(ByVal ws As Worksheet)
    Dim datePart As String
    Dim basePath As String, cjPath As String
    Dim joePrefix As String, impPrefix As String
    Dim joeNameToday As String, impNameToday As String
    Dim joePath As String, impPath As String

    If CountPlaceOrder(ws) = 0 Then
        MsgBox "【采菁】中没有 ""place order"" 行，未生成任何文件。", vbInformation
        Exit Sub
    End If

    datePart = Format(Date, "yyyymmdd")
    basePath = ThisWorkbook.Path

    cjPath = "D:\JoeProgramFiles\Automation\Batch_added_to_cart"
    If Dir(cjPath, vbDirectory) = "" Then
        On Error Resume Next
        MkDir cjPath
        On Error GoTo 0
    End If
    If Right$(cjPath, 1) <> "\" And Right$(cjPath, 1) <> "/" Then
        cjPath = cjPath & Application.PathSeparator
    End If

    joePrefix = "Joe77采购单_采菁"
    impPrefix = "Bigseller采购导入_采菁"

    joeNameToday = joePrefix & datePart & ".xlsx"
    impNameToday = impPrefix & datePart & ".xlsx"

    EnsureTodayFile cjPath, joePrefix, joeNameToday
    EnsureTodayFile basePath, impPrefix, impNameToday

    joePath = cjPath & joeNameToday
    impPath = basePath & Application.PathSeparator & impNameToday

    gJoePath = joePath
    gImpPath = impPath

    Export_Caijing_Joe77 ws, joePath
    Export_ImportFile ws, impPath
End Sub

Private Sub Export_Caijing_Joe77(ByVal wsSrc As Worksheet, ByVal filePath As String)
    Dim wb As Workbook, ws As Worksheet
    Dim skuCol As Long, qtyCol As Long, linkCol As Long, prodIDCol As Long
    Dim attrCol As Long, skuIDCol As Long, specIDCol As Long, suppCol As Long, actCol As Long
    Dim lastRow As Long, dstRow As Long, r As Long, actVal As String
    Dim oldAlerts As Boolean

    actCol = FindHeaderCol(wsSrc, "action")
    skuCol = FindHeaderCol(wsSrc, "SKU")
    qtyCol = FindHeaderCol(wsSrc, "数量")
    linkCol = FindHeaderCol(wsSrc, "商品链接")
    prodIDCol = FindHeaderCol(wsSrc, "商品ID")
    attrCol = FindHeaderCol(wsSrc, "属性SKU")
    skuIDCol = FindHeaderCol(wsSrc, "sku ID")
    specIDCol = FindHeaderCol(wsSrc, "Spec ID")
    suppCol = FindHeaderCol(wsSrc, "供应商")

    If actCol = 0 Or skuCol = 0 Or qtyCol = 0 Or linkCol = 0 Or prodIDCol = 0 Or attrCol = 0 Or skuIDCol = 0 Or specIDCol = 0 Or suppCol = 0 Then
        MsgBox "【采菁】中未找到所有必需表头（action, SKU, 数量, 商品链接, 商品ID, 属性SKU, sku ID, Spec ID, 供应商）。", vbCritical
        Exit Sub
    End If

    If Dir(filePath) <> "" Then
        Set wb = Workbooks.Open(filePath)
        Set ws = wb.Worksheets(1)
        lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
        If lastRow < 2 Then lastRow = 2
        ws.Range(ws.Cells(2, 1), ws.Cells(lastRow, 8)).ClearContents
    Else
        Set wb = Workbooks.Add(xlWBATWorksheet)
        Set ws = wb.Worksheets(1)
    End If

    ws.Cells(1, 1).Value = "SKU"
    ws.Cells(1, 2).Value = "数量"
    ws.Cells(1, 3).Value = "商品链接"
    ws.Cells(1, 4).Value = "商品ID"
    ws.Cells(1, 5).Value = "属性SKU"
    ws.Cells(1, 6).Value = "sku ID"
    ws.Cells(1, 7).Value = "Spec ID"
    ws.Cells(1, 8).Value = "供应商"

    lastRow = wsSrc.Cells(wsSrc.Rows.Count, actCol).End(xlUp).Row
    dstRow = 2

    For r = 2 To lastRow
        actVal = LCase$(Trim$(CStr(wsSrc.Cells(r, actCol).Value)))
        If actVal = "place order" Then
            ws.Cells(dstRow, 1).Value = wsSrc.Cells(r, skuCol).Value
            ws.Cells(dstRow, 2).Value = wsSrc.Cells(r, qtyCol).Value
            ws.Cells(dstRow, 3).Value = wsSrc.Cells(r, linkCol).Value
            ws.Cells(dstRow, 4).Value = wsSrc.Cells(r, prodIDCol).Value
            ws.Cells(dstRow, 5).Value = wsSrc.Cells(r, attrCol).Value
            ws.Cells(dstRow, 6).Value = wsSrc.Cells(r, skuIDCol).Value
            ws.Cells(dstRow, 7).Value = wsSrc.Cells(r, specIDCol).Value
            ws.Cells(dstRow, 8).Value = wsSrc.Cells(r, suppCol).Value
            dstRow = dstRow + 1
        End If
    Next r

    ws.Columns.AutoFit

    oldAlerts = Application.DisplayAlerts
    Application.DisplayAlerts = False
    wb.SaveAs fileName:=filePath, FileFormat:=xlOpenXMLWorkbook
    wb.Close SaveChanges:=False
    Application.DisplayAlerts = oldAlerts
End Sub

' -------- Helpers --------
Private Function StripPrefixCI(ByVal s As String, ByVal prefix As String) As String
    If Len(prefix) = 0 Then StripPrefixCI = s: Exit Function
    If Len(s) >= Len(prefix) Then
        If StrComp(Left$(s, Len(prefix)), prefix, vbTextCompare) = 0 Then
            StripPrefixCI = Mid$(s, Len(prefix) + 1)
            Exit Function
        End If
    End If
    StripPrefixCI = s
End Function

Private Function FindHeaderCol(ByVal ws As Worksheet, ByVal headerText As String) As Long
    Dim lastCol As Long, c As Long
    Dim cellText As String

    lastCol = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column
    For c = 1 To lastCol
        cellText = CStr(ws.Cells(1, c).Value)
        cellText = Replace(cellText, vbCr, " ")
        cellText = Replace(cellText, vbLf, " ")
        cellText = Application.WorksheetFunction.Trim(cellText)
        If StrComp(cellText, headerText, vbTextCompare) = 0 Then
            FindHeaderCol = c
            Exit Function
        End If
    Next c
End Function

